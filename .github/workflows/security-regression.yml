name: Security & Functional Regression

on:
  push:
    branches: [ main ]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      target-url: ${{ steps.set-url.outputs.target-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set TARGET_URL
        id: set-url
        run: |
          TARGET_URL="${{ secrets.TARGET_URL }}"
          if [ -z "$TARGET_URL" ]; then
            echo "❌ ERROR: TARGET_URL secret is not defined in GitHub Settings!"
            echo "Please go to Settings > Secrets and variables > Actions > New repository secret"
            echo "Name: TARGET_URL"
            echo "Value: http://your-vm-ip/ (e.g. http://4.233.87.143/)"
            exit 1
          fi
          echo "✅ TARGET_URL is set"
          echo "target-url=$TARGET_URL" >> $GITHUB_OUTPUT

  functional:
    name: Run functional tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run functional tests
        env:
          TARGET_URL: ${{ needs.setup.outputs.target-url }}
        run: ./tests/check_functional.sh

  security:
    name: Run security tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run security tests
        env:
          TARGET_URL: ${{ needs.setup.outputs.target-url }}
        run: ./tests/check_security.sh

# Note:
# - Optionally set the repository secret `TARGET_URL` to override the default in tests/config.sh
# - Jobs are run in parallel for efficiency
