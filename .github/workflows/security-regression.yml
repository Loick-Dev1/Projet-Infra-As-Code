name: Security & Functional Regression

on:
  push:
    branches: [ main ]

jobs:
  tests:
    name: Run regression tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Set TARGET_URL from config.sh
        run: |
          TARGET_URL="${{ secrets.TARGET_URL }}"
          if [ -z "$TARGET_URL" ]; then
            echo "WARNING: TARGET_URL secret not set. Tests will use value from tests/config.sh"
            TARGET_URL=$(grep "^TARGET_URL=" tests/config.sh | cut -d'=' -f2 | sed 's/"//g' | sed "s/'//g")
          fi
          echo "TARGET_URL=$TARGET_URL" >> $GITHUB_ENV

      - name: Run functional tests
        env:
          TARGET_URL: ${{ env.TARGET_URL }}
        run: ./tests/check_functional.sh

      - name: Run security tests
        env:
          TARGET_URL: ${{ env.TARGET_URL }}
        run: ./tests/check_security.sh

# Note:
# - Optionally set the repository secret `TARGET_URL` to override the default in tests/config.sh
# - If not set, the workflow will use the URL defined in tests/config.sh
