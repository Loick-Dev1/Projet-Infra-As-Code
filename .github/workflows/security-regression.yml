name: Security & Functional Regression

on:
  push:
    branches: [ main ]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      target-url: ${{ steps.set-url.outputs.target-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set TARGET_URL
        id: set-url
        run: |
          TARGET_URL="${{ secrets.TARGET_URL }}"
          if [ -z "$TARGET_URL" ]; then
            echo "WARNING: TARGET_URL secret not set"
            TARGET_URL=$(grep "^TARGET_URL=" tests/config.sh | cut -d'=' -f2 | sed 's/"//g' | sed "s/'//g")
          fi
          echo "target-url=$TARGET_URL" >> $GITHUB_OUTPUT

  functional:
    name: Run functional tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run functional tests
        env:
          TARGET_URL: ${{ needs.setup.outputs.target-url }}
        run: ./tests/check_functional.sh

  security:
    name: Run security tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run security tests
        env:
          TARGET_URL: ${{ needs.setup.outputs.target-url }}
        run: ./tests/check_security.sh

# Note:
# - Optionally set the repository secret `TARGET_URL` to override the default in tests/config.sh
# - Jobs are run in parallel for efficiency
